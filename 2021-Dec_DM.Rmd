---
title: "Dustin's Analysis"
output: html_document
---

#Load Libraries
```{r}
library(phyloseq)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
```

#Define Paths
```{r}
rds <- "/work/kdm65/2021-Dec.rds"
```

Load and check phyloseq object
```{r}
all_mice.ps <- readRDS(rds)
print(all_mice.ps)
```

```{r}
sample_variables(all_mice.ps)
```

Subset for just Dustin's mice and remove bad samples
```{r}
just.dustin.ps <- all_mice.ps %>%
  subset_samples(Owner == "Dustin") %>%
  subset_samples(!SampleName %in% c("2086-Day7","PBS-Day14"))
just.dustin.ps
```

```{r}
plot_bar(just.dustin.ps)
```
None of these samples stand out as having super low read counts, so I don't need to prune any out.

#Relative Abundance
```{r}
rel.ps <- just.dustin.ps %>%
  transform_sample_counts(function(x) x/sum(x))
```

#Abundance Plots
```{r}
AbundancePlot.SampleName = function(ps, tax_level) {
  ps %>%
    plot_bar(fill = tax_level, x = "SampleName") +
    labs(y = "Relative Abundance") +
    geom_bar(aes_string(color = tax_level, fill = tax_level),
             stat = "identity",
             position = "stack")
}

AbundancePlot.Day = function(ps, tax_level) {
  ps %>%
    plot_bar(fill = tax_level, x = "Day") +
    labs(y = "Relative Abundance") +
    geom_bar(aes_string(color = tax_level, fill = tax_level),
             stat = "identity",
             position = "stack")
}
```

Since there are two day 0 Akk_free samples, faceting by day combines those two samples with a summed relative abundance of 2.0, so I will plot the Akk_free separate from the other groups.

```{r}
akk_free.ps <- rel.ps %>%
  subset_samples(Group == "Akk_free")

AbundancePlot.SampleName(akk_free.ps, "Phylum") +
  facet_grid(~Group, scale="free_x", space="free_x")
```

```{r}
gavaged.ps <- rel.ps %>%
  subset_samples(Group != "Akk_free")

AbundancePlot.Day(gavaged.ps, "Phylum") +
  facet_grid(~Group~Day, , scale="free_x", space="free_x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

It looks like there might be something going on with the actinobacteriota. They're present in the pre-gavage akk free samples and the later PBS samples but are much less prevalent in samples of mice gavaged with akkermansia.

#Pruning
Prune to the top 20 genera
```{r}
rel.ps %>%
  taxa_sums %>%
  sort(decreasing = TRUE) %>%
  names %>%
  head(20) ->
  top20

rel.ps %>%
  prune_taxa(top20, .) ->
  prune20.rel
prune20.rel
```

```{r}
pruned.akk_free.ps <- prune20.rel %>%
  subset_samples(Group == "Akk_free")

AbundancePlot.SampleName(pruned.akk_free.ps, "Genus") +
  facet_grid(~Group, scale="free_x", space="free_x")
```

```{r}
pruned.gavaged.ps <- prune20.rel %>%
  subset_samples(Group != "Akk_free")

AbundancePlot.Day(pruned.gavaged.ps, "Genus") +
  facet_grid(~Group~Day, , scale="free_x", space="free_x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

#Akkermansia
```{r}
akks.ps <- rel.ps %>%
  subset_taxa(Genus == "Akkermansia") %>%
  tax_glom(taxrank = "Genus")
print(akks.ps)
```

```{r}
akks <- akks.ps %>%
  otu_table() %>%
  as.data.frame()
```

Beta
```{r}
even.ps <- transform_sample_counts(just.dustin.ps, function(x) 1E6 * x/sum(x))
```

```{r}
even.nmds_bs <- ordinate(even.ps, "NMDS", "bray")
```

```{r}
plot_ordination(even.ps, even.nmds_bs, type = "samples", color = "Day", shape = "Group")
```

